#!/bin/bash
set -euo pipefail

rm -f phi
rm -rf debug
mkdir -p debug

# Generate variants of the phi image
PHI_DEBUG_SYMBOLS=debug/phi1prod ./phi0.pl > phi1
chmod 755 phi1

./phi1 > phi2
chmod 755 phi2

if [[ ${1:---debug} == "--debug" ]]; then
  PHI_DEBUG_MISSING_METHODS=1 PHI_DEBUG_ILLEGAL_INSNS=1 \
    PHI_ILLEGAL_SEGFAULT_OK=0 \
    PHI_DEBUG_SYMBOLS=debug/phi1 \
    ./phi0.pl > debug/phi1

  chmod 755 debug/phi1
fi
