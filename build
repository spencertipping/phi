#!/bin/bash
set -euo pipefail

rm -rf debug
mkdir -p debug

# Generate variants of the phi image
./phi2repl.pl > phi2repl.elf
chmod 755 phi2repl.elf

PHI_DEBUG_SYMBOLS=debug/phi1 time ./phi0.pl > phi1.elf
chmod 755 phi1.elf

if [[ ${1:-} == "--debug" ]]; then
  PHI_DEBUG_MISSING_METHODS=1 \
  PHI_DEBUG_ILLEGAL_INSNS=1 \
  PHI_DEBUG_TRACE_INSNS=1 \
  PHI_DEBUG_SYMBOLS=debug/phi1-trace \
  time ./phi0.pl > debug/phi1-trace

  chmod 755 debug/phi1-trace
fi

# NB: do this last so we get an updated debug image
time ./phi1.elf 3>phi1.prof > phi2.elf
chmod 755 phi2.elf

# Snapshot the method counts
dev/ni phi1.prof rBrp'b eq "method"' F/::/fDAg,sgApF_ >phi1.mcounts
