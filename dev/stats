#!/bin/bash
shopt -s extglob
cd "$(dirname "$0")/.."

the_diff=$(mktemp -u)
git diff $1 !(shelved) > "$the_diff"

ins=( $the_diff rp's/^\+([^+])/$1/' FSF^S gu )
del=( $the_diff rp's/^-([^-])/$1/'  FSF^S gu )

echo "commits:          $(git log --oneline | wc -l)"
echo "commits since:    $(git log --oneline ...$1 | wc -l)"
echo "insertions:       $(ni "${ins[@]}" rIA[ "${del[@]}" ] e'wc -l')"
echo "deletions:        $(ni "${del[@]}" rIA[ "${ins[@]}" ] e'wc -l')"
echo "abs insertions:   $(grep ^+[^+] $the_diff | wc -l)"
echo "abs deletions:    $(grep ^-[^-] $the_diff | wc -l)"

echo "boot code size:   $(ni phiboot.pl phiboot/*.pm e'wc -l') line(s)"
echo

./build
echo "phi size:         $(ni 1p'-s "phi"')"
echo "anon allocations: $(ni debug/phiprod.symbols rp'd =~ /anon/' e'wc -l')"
echo "largest allocations:"
ni debug/phiprod.symbols OB r10 p'"  $_"' | cat

echo
echo "TODO items:"
grep -c -R TODO phiboot* | egrep -v ':0$|\.swp' | sed 's/^/  /'
echo

rm "$the_diff"
